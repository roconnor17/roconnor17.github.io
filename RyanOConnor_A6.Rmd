---
title: "Assignment 6"
author: "RyanOConnor"
date: "11/02/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
```

```{r}
library(tidyverse)
library(leaflet)
library(censusapi)
library(sf)
library(mapview)
library(tigris)
library(readxl)
library(survey)

Sys.setenv(CENSUS_KEY="cccdf64b447748daaddebe5f9aeaec92fc4b744c")
```

#**PART 1:**

In Figure 1 below, we see the Public use Microdata Areas (PUMAs) for San Francisco County, CA mapped. In this example, we can see some strange geographic anomalies in the borders for these PUMAs. First, when looking at North Beach and Chinatown PUMA in the Northeast portion of the city, we see that the shape also encompasses land are across the Bay in Alameda in the southwest corner of the airfield, as well as on Angel Island near Fort McDowell. When examining the OpenStreetMap layer in the leaflet map output, it becomes clear why these anomalies occur. Both shapes terminate on one end along the San Francisco County line, which to me indicates that the automated model that the Census Bureau used to generate their PUMA shapefiles clipped them at county lines. Because of the quirk of where the San Francisco County line terminates, this meant that small slivers of land area became attributed to what I suspect the Census Bureau would agree is the wrong PUMA. A third geographic anomaly can be seen as part of the Richmond District. Several miles out to see West of the Bay is the Southeast Farralon Island State Marine Conservation Area. As the OpenStreetMap layer shows, this area is jurisdictionally part of San Francisco City and County, and therefor became attributed within the PUMA of Northwest San Francisco County. Fortunately, all three of these anomalous areas are uninhabited; one is a park, one a decommissioned airfield, one a wildlife preserve. So for the purposes of analysis, they should not affect any outputs when investigating PUMS data. 

```{r}
pums_2019_1yr <- getCensus(
  name = "acs/acs1/pums",
  vintage = 2019,
  region = "public use microdata area:*", 
  regionin = "state:06",
  vars = c(
    "SERIALNO",
    "SPORDER",
    "YBL",
    "BLD",
    "MV",
    "NP",
    "HHL",
    "HINCP",
    "TEN",
    "AGEP",
    "HUPAC"
  )
)

ca_pumas <-
  pumas("CA", cb = T, progress_bar = F)

SF_county_name <-
"San Francisco"

SF_county <-
  counties("CA", cb = T, progress_bar = F) %>%
  filter(NAME %in% SF_county_name)

SF_PUMA <-
  ca_pumas %>% 
  st_centroid() %>% 
  .[SF_county, ] %>% 
  st_drop_geometry() %>% 
  left_join(ca_pumas %>% select(GEOID10)) %>% 
  st_as_sf()

leaflet() %>%
  addTiles() %>% 
  addPolygons(
    data = SF_PUMA,
    fillColor = "Blue",
    color = "white",
    opacity = 0.5,
    fillOpacity = 0.3,
    weight = 2,
    label = SF_PUMA$NAME10,
    highlightOptions = highlightOptions(
      weight = 2,
      opacity = 1
    )
  )
```

**Figure 1. A map of San Francisco County Public Use Microdata Areas (PUMAs)


```{r}
SF_pums <-
  pums_2019_1yr %>% 
  mutate(
    PUMA = str_pad(public_use_microdata_area,5,"left","0")
  ) %>% 
  filter(PUMA %in% SF_PUMA$PUMACE10)

SF_pums_clean <-
  SF_pums %>% 
  mutate(YBL = as.numeric(YBL),
         HINCP = as.numeric(HINCP),
         BLD = as.numeric(BLD),
         TEN = as.numeric(TEN),
         MV = as.numeric(MV),
         PUMA = as.numeric(PUMA),
         AGEP = as.numeric(AGEP)) %>%
  filter(SF_pums$YBL %in% 1:3) %>%
  group_by(SERIALNO) %>%
  arrange(AGEP) %>%
  summarize_all(first)

SF_pums_leadrisk <- SF_pums_clean %>% 
  mutate(leadrisk =
           ifelse(
             (HINCP < 90000) &
               (AGEP %in% 0:5),
             1,
             0
           ))

SF_pums_factor <- SF_pums_leadrisk %>%
  mutate(
    building = BLD %>%
      factor(
        levels = SF_pums_leadrisk$BLD %>%
          unique() %>%
          as.numeric() %>%
          sort()
      ),
    tenure = TEN %>%
      factor(
        levels = SF_pums_leadrisk$TEN %>%
          unique() %>%
          as.numeric() %>%
          sort()
      ),
    move = MV %>%
      factor(
        levels = SF_pums_leadrisk$MV %>%
          unique() %>%
          as.numeric() %>%
          sort()
      ),
    puma1 = PUMA %>%
      factor(
        levels = SF_pums_leadrisk$PUMA %>%
          unique() %>%
          as.numeric() %>%
          sort()
      ),
    leadrisk = as.numeric(leadrisk)
  )

```

Below is a summary output of the logit model with the factors of Building, Tenure, Move, and PUMA.

```{r}
SF_pums_logit <- glm(
  leadrisk ~ building + tenure + move + puma1,
  family = quasibinomial(),
  data = SF_pums_factor
)

summary(SF_pums_logit)
```


Below is the predicted probability of a randomly selected row that a home has a household income below $90,000 per year _and_ has at least one child below the age of six (i.e. their "leadrisk" is TRUE.

```{r}
predict(SF_pums_logit, sample_n(SF_pums_factor,1), type = "response")
```

#**PART 2:**

```{r}
Full_predict <- predict(SF_pums_logit, SF_pums_factor, type = "response")

SF_pums_logit_predicted <- cbind(SF_pums_factor, Full_predict)
```

```{r}
summary_2x2 <-
  SF_pums_logit_predicted %>% 
  mutate(
    leadrisk = ifelse(
      leadrisk == 1, 
      "Lead Risk", 
      "No Lead Risk"
    )
  ) %>% 
  pull(leadrisk) %>% 
  table(Full_predict > 0.1)

summary_2x2
```

